var base,base1,extend=function(t,e){for(var i in e){if(hasProp.call(e,i))t[i]=e[i]}function n(){this.constructor=t}n.prototype=e.prototype;t.prototype=new n;t.__super__=e.prototype;return t},hasProp={}.hasOwnProperty,bind=function(t,e){return function(){return t.apply(e,arguments)}};this.Bu={version:"0.2.0",DEFAULT_STROKE_STYLE:"#048",DEFAULT_FILL_STYLE:"rgba(64, 128, 192, 0.5)",DEFAULT_DASH_STYLE:[8,4],DEFAULT_STROKE_STYLE_HOVER:"rgba(255, 128, 0, 0.75)",DEFAULT_FILL_STYLE_HOVER:"rgba(255, 128, 128, 0.5)",DEFAULT_TEXT_FILL_STYLE:"black",DEFAULT_IMAGE_SIZE:20,POINT_RENDER_SIZE:4,DEFAULT_BOUND_STROKE_STYLE:"#444",DEFAULT_BOUND_DASH_STYLE:[6,6],DEFAULT_NEAR_DIST:5,MOUSE_BUTTON_NONE:-1,MOUSE_BUTTON_LEFT:0,MOUSE_BUTTON_MIDDLE:1,MOUSE_BUTTON_RIGHT:2};Bu.average=function(){var t,e,i,n,s;n=arguments;if(typeof arguments[0]==="object"){n=arguments[0]}s=0;for(e=0,i=n.length;e<i;e++){t=n[e];s+=t}return s/n.length};Bu.bevel=function(t,e){return Math.sqrt(t*t+e*e)};Bu.rand=function(t,e){if(e==null){e=t;t=0}return Math.random()*(e-t)+t};Bu.now=Date.now;Bu.combineOptions=function(t,e){var i,n;if(e==null){e={}}i=t[t.length-1];if(typeof i==="object"){for(n in i){e[n]=i[n]}}return e};Function.prototype.property=function(t,e){return Object.defineProperty(this.prototype,t,e)};(base=Array.prototype).each||(base.each=function(t){var e;e=0;while(e<this.length){t(this[e]);e++}return this});(base1=Array.prototype).map||(base1.map=function(t){var e,i;e=[];i=0;while(i<this.length){e.push(t(this[i]));i++}return this});Bu.Vector=function(){function t(t,e){this.x=t;this.y=e}t.prototype.set=function(t,e){this.x=t;this.y=e};return t}();Bu.Event=function(){var t;t={};this.on=function(e,i){var n;n=t[e]||(t[e]=[]);if(n.indexOf(i===-1)){return n.push(i)}};this.once=function(t,e){e.once=true;return this.on(t,e)};this.off=function(e,i){var n,s;s=t[e];if(i!=null){if(s!=null){n=s.indexOf(i);if(n>-1){return s.splice(n,1)}}}else{if(s!=null){return s.length=0}}};return this.trigger=function(e,n){var s,r,o,h,l;h=t[e];if(h!=null){n||(n={});n.target=this;l=[];for(s=0,r=h.length;s<r;s++){o=h[s];o.call(this,n);if(o.once){h.splice(i,1);l.push(i-=1)}else{l.push(void 0)}}return l}}};(function(t){var e;t.$=function(t){var i;i=[];if(typeof t==="string"){i=[].slice.call(document.querySelectorAll(t))}e.apply(i);return i};e=function(){var t;this.on=function(t){return function(e,i){t.each(function(t){return t.addEventListener(e,i)});return t}}(this);this.off=function(t){return function(e,i){t.each(function(t){return t.removeEventListener(e,i)});return t}}(this);t="svg line rect circle ellipse polyline polygon path text";this.append=function(e){return function(i){e.each(function(n,s){var r,o;o=t.indexOf(i.toLowerCase());if(o>-1){r=document.createElementNS("http://www.w3.org/2000/svg",i)}else{r=document.createElement(i)}return e[s]=n.appendChild(r)});return e}}(this);this.text=function(t){return function(e){t.each(function(t){return t.textContent=e});return t}}(this);this.html=function(t){return function(e){t.each(function(t){return t.innerHTML=e});return t}}(this);this.style=function(t){return function(e,i){t.each(function(t){var n,s,r;s=t.getAttribute("style");r={};if(s){s.split(";").each(function(t){var e;e=t.split(":");return r[e[0]]=e[1]})}r[e]=i;s="";for(n in r){s+=n+": "+r[n]+"; "}return t.setAttribute("style",s)});return t}}(this);this.hasClass=function(t){return function(e){var i,n,s;if(t.length===0){return false}s=0;while(s<t.length){i=t[s].getAttribute("class"||"");n=i.split(RegExp(" +"));if(!n.contains(e)){return false}s++}return t}}(this);this.addClass=function(t){return function(e){t.each(function(t){var i,n;i=t.getAttribute("class"||"");n=i.split(RegExp(" +"));if(!n.contains(e)){n.push(e);return t.setAttribute("class",n.join(" "))}});return t}}(this);this.removeClass=function(t){return function(e){t.each(function(t){var i,n;i=t.getAttribute("class")||"";n=i.split(RegExp(" +"));if(n.contains(e)){n.remove(e);if(n.length>0){return t.setAttribute("class",n.join(" "))}else{return t.removeAttribute("class")}}});return t}}(this);this.toggleClass=function(t){return function(e){t.each(function(t){var i,n;i=t.getAttribute("class"||"");n=i.split(RegExp(" +"));if(n.contains(e)){n.remove(e)}else{n.push(e)}if(n.length>0){return t.setAttribute("class",n.join(" "))}else{return t.removeAttribute("class")}});return t}}(this);this.attr=function(t){return function(e,i){i||(i="");t.each(function(t){return t.setAttribute(e,i)});return t}}(this);this.hasAttr=function(t){return function(e){var i;if(t.length===0){return false}i=0;while(i<t.length){if(!t[i].hasAttribute(e)){return false}i++}return t}}(this);return this.removeAttr=function(t){return function(e){t.each(function(t){return t.removeAttribute(e)});return t}}(this)};t.$.ready=function(t){return document.addEventListener("DOMContentLoaded",t)};return t.$.ajax=function(t,e){var i;if(!e){if(typeof t==="object"){e=t;t=e.url}else{e={}}}e.method||(e.method="GET");if(e.async==null){e.async=true}i=new XMLHttpRequest;i.onreadystatechange=function(){if(i.readyState===4){if(i.status===200){if(e.success!=null){return e.success(i.responseText,i.status,i)}}else{if(e.error!=null){e.error(i,i.status)}if(e.complete!=null){return e.complete(i,i.status)}}}};i.open(e.method,t,e.async,e.username,e.password);return i.send(null)}})(window||this);Bu.Object2D=function(){function t(){Bu.Colorful.apply(this);Bu.Event.apply(this);this.visible=true;this.opacity=1;this.position=new Bu.Vector;this.rotation=0;this.scale=new Bu.Vector(1,1);this.skew=new Bu.Vector;this.bounds=null;this.keyPoints=null;this.children=[];this.parent=null}t.prototype.containsPoint=function(t){if(this.bounds!=null&&!this.bounds.containsPoint(t)){return false}else if(this._containsPoint){return this._containsPoint(t)}else{return false}};return t}();Bu.Size=function(){function t(t,e){this.width=t;this.height=e;this.type="Size"}t.prototype.set=function(t,e){this.width=t;return this.height=e};return t}();Bu.Bounds=function(t){extend(e,t);function e(t){var i,n,s,r,o,h,l;this.target=t;e.__super__.constructor.call(this);this.type="Bounds";this.x1=this.y1=this.x2=this.y2=0;this.isEmpty=true;this.point1=new Bu.Point;this.point2=new Bu.Point;this.strokeStyle=Bu.DEFAULT_BOUND_STROKE_STYLE;this.dashStyle=Bu.DEFAULT_BOUND_DASH_STYLE;this.dashDelta=0;switch(this.target.type){case"Line":case"Triangle":case"Rectangle":o=this.target.points;for(i=0,n=o.length;i<n;i++){l=o[i];this.expandByPoint(l)}break;case"Circle":case"Bow":case"Fan":this.expandByCircle(this.target);this.target.on("centerChanged",function(t){return function(){t.clear();return t.expandByCircle(t.target)}}(this));this.target.on("radiusChanged",function(t){return function(){t.clear();return t.expandByCircle(t.target)}}(this));break;case"Polyline":case"Polygon":h=this.target.vertices;for(r=0,s=h.length;r<s;r++){l=h[r];this.expandByPoint(l)}break;default:console.warn('Bounds: not support shape type "'+this.target.type+'"')}}e.prototype.containsPoint=function(t){return this.x1<t.x&&this.x2>t.x&&this.y1<t.y&&this.y2>t.y};e.prototype.clear=function(){this.x1=this.y1=this.x2=this.y2=0;return this.isEmpty=true};e.prototype.expandByPoint=function(t){if(this.isEmpty){this.isEmpty=false;this.x1=this.x2=t.x;return this.y1=this.y2=t.y}else{if(t.x<this.x1){this.x1=t.x}if(t.x>this.x2){this.x2=t.x}if(t.y<this.y1){this.y1=t.y}if(t.y>this.y2){return this.y2=t.y}}};e.prototype.expandByCircle=function(t){var e,i;e=t.center;i=t.radius;if(this.isEmpty){this.isEmpty=false;this.x1=e.x-i;this.x2=e.x+i;this.y1=e.y-i;return this.y2=e.y+i}else{if(e.x-i<this.x1){this.x1=e.x-i}if(e.x+i>this.x2){this.x2=e.x+i}if(e.y-i<this.y1){this.y1=e.y-i}if(e.y+i>this.y2){return this.y2=e.y+i}}};return e}(Bu.Object2D);Bu.Colorful=function(){this.strokeStyle=Bu.DEFAULT_STROKE_STYLE;this.fillStyle=Bu.DEFAULT_FILL_STYLE;this.dashStyle=false;this.lineWidth=1;this.dashDelta=0;this.stroke=function(t){if(t==null){t=true}switch(t){case true:this.strokeStyle=Bu.DEFAULT_STROKE_STYLE;break;case false:this.strokeStyle=null;break;default:this.strokeStyle=t}return this};this.fill=function(t){if(t==null){t=true}switch(t){case false:this.fillStyle=null;break;case true:this.fillStyle=Bu.DEFAULT_FILL_STYLE;break;default:this.fillStyle=t}return this};return this.dash=function(t){if(t==null){t=true}if(typeof t==="number"){t=[t,t]}switch(t){case false:this.dashStyle=null;break;case true:this.dashStyle=Bu.DEFAULT_DASH_STYLE;break;default:this.dashStyle=t}return this}};Bu.Point=function(t){var e;extend(i,t);function i(t,e){this.x=t!=null?t:0;this.y=e!=null?e:0;i.__super__.constructor.call(this);this.stroke(false);this.type="Point";this._labelIndex=-1}i.property("label",{get:function(){if(this._labelIndex>-1){return this.children[this._labelIndex].text}else{return""}},set:function(t){var e;if(this._labelIndex===-1){e=new Bu.PointText(t,this.x+Bu.POINT_RENDER_SIZE,this.y,{align:"+0"});this.children.push(e);return this._labelIndex=this.children.length-1}else{return this.children[this._labelIndex].text=t}}});i.prototype.arcTo=function(t,e){return new Bu.Point(this.x+Math.cos(e)*t,this.y+Math.sin(e)*t)};i.prototype.clone=function(){return new Bu.Point(this.x,this.y)};i.prototype.copy=function(t){this.x=t.x;this.y=t.y;return this.updateLabel()};i.prototype.set=function(t,e){this.x=t;this.y=e;return this.updateLabel()};i.prototype.updateLabel=function(){if(this._labelIndex>-1){this.children[this._labelIndex].x=this.x+Bu.POINT_RENDER_SIZE;return this.children[this._labelIndex].y=this.y}};i.prototype.distanceTo=function(t){return Bu.bevel(this.x-t.x,this.y-t.y)};e=null;i.prototype.isNear=function(t,i){var n,s,r,o,h,l,a;if(i==null){i=Bu.DEFAULT_NEAR_DIST}switch(t.type){case"Point":return this.distanceTo(t)<i;case"Line":a=t.distanceTo(this);if(e==null){e=new Bu.Point}t.footPointFrom(this,e);n=e.distanceTo(t.points[0])<t.length+Bu.DEFAULT_NEAR_DIST;s=e.distanceTo(t.points[1])<t.length+Bu.DEFAULT_NEAR_DIST;return a<i&&n&&s;case"Polyline":l=t.lines;for(r=0,o=l.length;r<o;r++){h=l[r];if(this.isNear(h)){return true}}return false}};return i}(Bu.Object2D);Bu.Point.interpolate=function(t,e,i,n){var s,r;s=t.x+(e.x-t.x)*i;r=t.y+(e.y-t.y)*i;if(n!=null){return n.set(s,r)}else{return new Bu.Point(s,r)}};Bu.Line=function(t){extend(e,t);function e(t,i,n,s){e.__super__.constructor.call(this);this.type="Line";if(arguments.length<2){this.points=[new Bu.Point,new Bu.Point]}else if(arguments.length<4){this.points=[t.clone(),i.clone()]}else{this.points=[new Bu.Point(t,i),new Bu.Point(n,s)]}this.length;this.midpoint=new Bu.Point;this.keyPoints=this.points;this.on("pointChange",function(t){return function(e){t.length=t.points[0].distanceTo(t.points[1]);return t.midpoint.set((t.points[0].x+t.points[1].x)/2,(t.points[0].y+t.points[1].y)/2)}}(this));this.trigger("pointChange",this)}e.prototype.set=function(t,e,i,n){if(typeof p4!=="undefined"&&p4!==null){this.points[0].set(t,e);this.points[1].set(i,n)}else{this.points[0]=t;this.points[1]=e}this.trigger("pointChange",this);return this};e.prototype.setPoint1=function(t,e){if(e!=null){this.points[0].set(t,e)}else{this.points[0].copy(t)}this.trigger("pointChange",this);return this};e.prototype.setPoint2=function(t,e){if(e!=null){this.points[1].set(t,e)}else{this.points[1].copy(t)}this.trigger("pointChange",this);return this};e.prototype.isTwoPointsSameSide=function(t,e){var i,n,s,r;i=this.points[0];n=this.points[1];if(i.x===n.x){return(t.x-i.x)*(e.x-i.x)>0}else{s=(i.y-n.y)*(t.x-i.x)/(i.x-n.x)+i.y;r=(i.y-n.y)*(e.x-i.x)/(i.x-n.x)+i.y;return(t.y-s)*(e.y-r)>0}};e.prototype.distanceTo=function(t){var e,i,n,s;n=this.points[0];s=this.points[1];e=(n.y-s.y)/(n.x-s.x);i=n.y-e*n.x;return Math.abs(e*t.x+i-t.y)/Math.sqrt(e*e+1)};e.prototype.distanceTo2=function(t){var e,i,n,s,r,o;r=this.points[0];o=this.points[1];e=(r.y-o.y)/(r.x-o.x);i=r.y-(r.y-o.y)*r.x/(r.x-o.x);n=(t.y+t.x/e-i)/(e+1/e);s=e*n+i;return Bu.bevel(n-t.x,s-t.y)};e.prototype.footPointFrom=function(t,e){var i,n,s,r,o,h,l;r=this.points[0];o=this.points[1];i=(r.y-o.y)/(r.x-o.x);n=r.y-i*r.x;s=t.x+i*t.y;h=(s-i*n)/(i*i+1);l=i*h+n;if(e!=null){return e.set(h,l)}else{return new Bu.Point(h,l)}};e.prototype.getCrossPointWith=function(t){var e,i,n,s,r,o,h,l,a,u,c;l=this.points[0];a=this.points[1];u=t.points[0];c=t.points[1];e=a.y-l.y;n=l.x-a.x;r=e*l.x+n*l.y;i=c.y-u.y;s=u.x-c.x;o=i*u.x+s*u.y;h=e*s-i*n;return new Bu.Point((s*r-n*o)/h,(e*o-i*r)/h)};e.prototype.isCrossWithLine=function(t){var e,i,n,s,r,o,h,l,a,u,c;n=this.points[0].x;l=this.points[0].y;s=this.points[1].x;a=this.points[1].y;r=t.points[0].x;u=t.points[0].y;o=t.points[1].x;c=t.points[1].y;e=(a-l)*(o-r)-(c-u)*(s-n);if(e===0){return false}else{i=((s-n)*(o-r)*(u-l)+(a-l)*(o-r)*n-(c-u)*(s-n)*r)/e;h=((a-l)*(c-u)*(r-n)+(s-n)*(c-u)*l-(o-r)*(a-l)*u)/-e}return(i-n)*(i-s)<0&&(i-r)*(i-o)<0&&(h-l)*(h-a)<0&&(h-u)*(h-c)<0};e.prototype.isCrossWithLine2=function(t){var e,i,n,s,r,o,h,l,a,u;r=this.points[0];o=this.points[1];h=t.points[0];l=t.points[1];n=o.x-r.x;s=o.y-r.y;e=l.x-h.x;i=l.y-h.y;if(e*s-i*n===0){return false}a=(n*(h.y-r.y)+s*(r.x-h.x))/(e*s-i*n);u=(e*(r.y-h.y)+i*(h.x-r.x))/(i*n-e*s);return a>=0&&a<=1&&u>=0&&u<=1};return e}(Bu.Object2D);Bu.Circle=function(t){extend(e,t);function e(t,i,n){if(t==null){t=0}if(i==null){i=0}this._radius=n!=null?n:1;e.__super__.constructor.call(this);this.type="Circle";this._center=new Bu.Point(t,i);this.bounds=null;this.keyPoints=[this._center]}e.property("cx",{get:function(){return this._center.x},set:function(t){this._center.x=t;return this.trigger("centerChanged",this)}});e.property("cy",{get:function(){return this._center.y},set:function(t){this._center.y=t;return this.trigger("centerChanged",this)}});e.property("center",{get:function(){return this._center},set:function(t){this._center=t;this.cx=t.x;this.cy=t.y;this.keyPoints[0]=t;return this.trigger("centerChanged",this)}});e.property("radius",{get:function(){return this._radius},set:function(t){this._radius=t;this.trigger("radiusChanged",this);return this}});e.prototype._containsPoint=function(t){var e,i;e=t.x-this.cx;i=t.y-this.cy;return Bu.bevel(e,i)<this.radius};return e}(Bu.Object2D);Bu.Triangle=function(t){extend(e,t);function e(t,i,n){e.__super__.constructor.call(this);this.type="Triangle";this.lines=[new Bu.Line(t,i),new Bu.Line(i,n),new Bu.Line(n,t)];this.center=new Bu.Point(Bu.average(t.x,i.x,n.x),Bu.average(t.y,i.y,n.y));this.points=[t,i,n];this.keyPoints=this.points}e.prototype.area=function(){var t,e,i;t=this.points[0];e=this.points[1];i=this.points[2];return(e.x-t.x)*(i.y-t.y)-(i.x-t.x)*(e.y-t.y)};e.prototype._containsPoint=function(t){return this.lines[0].isTwoPointsSameSide(t,this.points[2])&&this.lines[1].isTwoPointsSameSide(t,this.points[0])&&this.lines[2].isTwoPointsSameSide(t,this.points[1])};return e}(Bu.Object2D);Bu.Rectangle=function(t){extend(e,t);function e(t,i,n,s){e.__super__.constructor.call(this);this.type="Rectangle";this.position=new Bu.Point(t,i);this.center=new Bu.Point(t+n/2,i+s/2);this.size=new Bu.Size(n,s);this.pointRT=new Bu.Point(t+n,i);this.pointRB=new Bu.Point(t+n,i+s);this.pointLB=new Bu.Point(t,i+s);this.points=[this.position,this.pointRT,this.pointRB,this.pointLB];this.keyPoints=this.points}e.prototype.containsPoint=function(t){return t.x>this.position.x&&t.y>this.position.y&&t.x<this.position.x+this.size.width&&t.y<this.position.y+this.size.height};return e}(Bu.Object2D);Bu.Fan=function(t){extend(e,t);function e(t,i,n,s,r){this.cx=t;this.cy=i;this.radius=n;this.aFrom=s;this.aTo=r;e.__super__.constructor.call(this);this.type="Fan";this.center=new Bu.Point(this.cx,this.cy);this.string=new Bu.Line(this.center.arcTo(this.radius,this.aFrom),this.center.arcTo(this.radius,this.aTo));this.keyPoints=this.string.points}e.prototype._containsPoint=function(t){var e,i,n;i=t.x-this.cx;n=t.y-this.cy;e=Math.atan2(t.y-this.cy,t.x-this.cx);while(e<this.aFrom){e+=Math.PI*2}return Bu.bevel(i,n)<this.radius&&e>this.aFrom&&e<this.aTo};return e}(Bu.Object2D);Bu.Bow=function(t){extend(e,t);function e(t,i,n,s,r){var o;this.cx=t;this.cy=i;this.radius=n;this.aFrom=s;this.aTo=r;e.__super__.constructor.call(this);if(this.aFrom>this.aTo){o=[this.aTo,this.aFrom],this.aFrom=o[0],this.aTo=o[1]}this.type="Bow";this.center=new Bu.Point(this.cx,this.cy);this.string=new Bu.Line(this.center.arcTo(this.radius,this.aFrom),this.center.arcTo(this.radius,this.aTo));this.keyPoints=this.string.points}e.prototype._containsPoint=function(t){var e,i;if(Bu.bevel(this.cx-t.x,this.cy-t.y)<this.radius){e=this.string.isTwoPointsSameSide(this.center,t);i=this.aTo-this.aFrom<Math.PI;return e^i}else{return false}};return e}(Bu.Object2D);Bu.Polygon=function(t){extend(e,t);function e(t){var i,n,s,r,o,h,l,a,u;e.__super__.constructor.call(this);this.type="Polygon";this.vertices=[];this.lines=[];this.triangles=[];o=Bu.combineOptions(arguments,{radius:100,angle:0});if(t instanceof Array){if(t!=null){this.vertices=t}}else{a=arguments[0];u=arguments[1];s=arguments[2];this.vertices=Bu.Polygon.generateRegularPoints(a,u,s,o)}if(this.vertices.length>1){for(i=n=0,h=this.vertices.length-1;0<=h?n<h:n>h;i=0<=h?++n:--n){this.lines.push(new Bu.Line(this.vertices[i],this.vertices[i+1]))}this.lines.push(new Bu.Line(this.vertices[this.vertices.length-1],this.vertices[0]))}if(this.vertices.length>2){for(i=r=1,l=this.vertices.length-1;1<=l?r<l:r>l;i=1<=l?++r:--r){this.triangles.push(new Bu.Triangle(this.vertices[0],this.vertices[i],this.vertices[i+1]))}}this.keyPoints=this.vertices}e.prototype.isSimple=function(){var t,e,i,n,s,r,o,h;n=this.lines.length;for(t=i=0,r=n;0<=r?i<r:i>r;t=0<=r?++i:--i){for(e=s=o=t+1,h=n;o<=h?s<h:s>h;e=o<=h?++s:--s){if(this.lines[t].isCrossWithLine(this.lines[e])){return false}}}return true};e.prototype.addPoint=function(t,e){if(e==null){this.vertices.push(t);if(this.vertices.length>1){this.lines[this.lines.length-1].points[1]=t}if(this.vertices.length>0){this.lines.push(new Bu.Line(this.vertices[this.vertices.length-1],this.vertices[0]))}if(this.vertices.length>2){return this.triangles.push(new Bu.Triangle(this.vertices[0],this.vertices[this.vertices.length-2],this.vertices[this.vertices.length-1]))}}else{return this.vertices.splice(e,0,t)}};e.prototype._containsPoint=function(t){var e,i,n,s;n=this.triangles;for(e=0,i=n.length;e<i;e++){s=n[e];if(s.containsPoint(t)){return true}}return false};e.generateRegularPoints=function(t,e,i,n){var s,r,o,h,l,a,u,c,p,f;r=n.angle;u=n.radius;a=[];o=Math.PI*2/i;for(h=l=0,c=i;0<=c?l<c:l>c;h=0<=c?++l:--l){s=h*o+r;p=t+u*Math.cos(s);f=e+u*Math.sin(s);a[h]=new Bu.Point(p,f)}return a};return e}(Bu.Object2D);Bu.Polyline=function(t){var e,i;extend(n,t);function n(t){this.vertices=t!=null?t:[];this.calcLength=bind(this.calcLength,this);this.updateLines=bind(this.updateLines,this);n.__super__.constructor.call(this);this.type="Polyline";this.lines=[];this.length=0;this.pointNormalizedPos=[];this.keyPoints=this.vertices;e(this)}e=function(t){if(t.vertices.length>1){t.updateLines();t.calcLength();return t.calcPointNormalizedPos()}};n.prototype.updateLines=function(){var t,e,i,n;n=[];for(t=e=0,i=this.vertices.length-1;0<=i?e<i:e>i;t=0<=i?++e:--e){if(this.lines[t]!=null){n.push(this.lines[t].set(this.vertices[t],this.vertices[t+1]))}else{n.push(this.lines[t]=new Bu.Line(this.vertices[t],this.vertices[t+1]))}}return n};n.prototype.calcLength=function(){var t,e,i,n;if(this.vertices.length<2){return this.length=0}else{i=0;for(t=e=1,n=this.vertices.length;1<=n?e<n:e>n;t=1<=n?++e:--e){i+=this.vertices[t].distanceTo(this.vertices[t-1])}return this.length=i}};n.prototype.calcPointNormalizedPos=function(){var t,e,i,n,s;t=0;this.pointNormalizedPos[0]=0;s=[];for(e=i=1,n=this.vertices.length;1<=n?i<n:i>n;e=1<=n?++i:--i){t+=this.vertices[e].distanceTo(this.vertices[e-1])/this.length;s.push(this.pointNormalizedPos[e]=t)}return s};n.prototype.getNormalizedPos=function(t){if(t!=null){return this.pointNormalizedPos[t]}else{return this.pointNormalizedPos}};i=function(t){var i,n,s;for(i=n=0,s=this.vertices.length;0<=s?n<s:n>s;i=0<=s?++n:--n){this.vertices[i].copy(t[i])}if(this.vertices.length>t.length){this.vertices.splice(t.length)}return e(this)};n.prototype.addPoint=function(t,i){if(i==null){this.vertices.push(t);if(this.vertices.length>1){this.lines.push(new Bu.Line(this.vertices[this.vertices.length-2],this.vertices[this.vertices.length-1]))}}else{this.vertices.splice(i,0,t)}return e(this)};return n}(Bu.Object2D);Bu.PointText=function(t){extend(e,t);function e(t,i,n){var s;this.text=t;this.x=i;this.y=n;this.setContextAlign=bind(this.setContextAlign,this);e.__super__.constructor.call(this);this.type="PointText";this.strokeStyle=null;this.fillStyle=Bu.DEFAULT_TEXT_FILL_STYLE;s=Bu.combineOptions(arguments,{align:"00",fontFamily:"Verdana",fontSize:11});this.align=s.align;this._fontFamily=s.fontFamily;this._fontSize=s.fontSize;this.font=this._fontSize+"px "+this._fontFamily||s.font;this.setContextAlign(this.align)}e.property("fontFamily",{get:function(){return this._fontFamily},set:function(t){this._fontFamily=t;return this.font=this._fontSize+"px "+this._fontFamily}});e.property("fontSize",{get:function(){return this._fontSize},set:function(t){this._fontSize=t;return this.font=this._fontSize+"px "+this._fontFamily}});e.prototype.setContextAlign=function(t){var e,i;if(t.length===1){t=""+t+t}e=t.substring(0,1);i=t.substring(1,2);this.textAlign=function(){switch(e){case"-":return"right";case"0":return"center";case"+":return"left"}}();return this.textBaseline=function(){switch(i){case"-":return"bottom";case"0":return"middle";case"+":return"top"}}()};return e}(Bu.Object2D);Bu.Image=function(t){extend(e,t);function e(t,i,n,s,r){this.url=t;e.__super__.constructor.call(this);this.type="Image";this.autoSize=true;this.size=new Bu.Size(Bu.DEFAULT_IMAGE_SIZE,Bu.DEFAULT_IMAGE_SIZE);this.position=new Bu.Vector(i,n);this.center=new Bu.Vector(i+s/2,n+r/2);if(s!=null){this.size.set(s,r);this.autoSize=false}this.pivot=new Bu.Vector(.5,.5);this.image=new window.Image;this.loaded=false;this.image.onload=function(t){return function(e){if(t.autoSize){t.size.set(t.image.width,t.image.height)}return t.loaded=true}}(this);this.image.src=this.url}return e}(Bu.Object2D);Bu.Renderer=function(){function t(){this.drawShape=bind(this.drawShape,this);this.drawShapes=bind(this.drawShapes,this);var t,e,i;Bu.Event.apply(this);this.type="Renderer";this.pixelRatio=(typeof window!=="undefined"&&window!==null?window.devicePixelRatio:void 0)||1;e=Bu.combineOptions(arguments,{width:800,height:600,fps:60,fillParent:false,showKeyPoints:false,border:false});this.width=e.width;this.height=e.height;this.fps=e.fps;this.container=e.container;this.fillParent=e.fillParent;this.isShowKeyPoints=e.showKeyPoints;this.tickCount=0;this.isRunning=false;this.dom=document.createElement("canvas");this.context=this.dom.getContext("2d");this.context.textBaseline="top";if(typeof ClipMeter!=="undefined"&&ClipMeter!==null){this.clipMeter=new ClipMeter}this.shapes=[];if(!this.fillParent){this.dom.style.width=this.width/this.pixelRatio+"px";this.dom.style.height=this.height/this.pixelRatio+"px";this.dom.width=this.width;this.dom.height=this.height}if(e.border!=null&&e.border){this.dom.style.border="solid 1px gray"}this.dom.style.cursor="crosshair";this.dom.style.boxSizing="border-box";this.dom.style.background="#eee";this.dom.oncontextmenu=function(){return false};window.canvas=this.dom;t=function(t){return function(){var e,i,n,s;e=t.dom.height/t.dom.width;i=t.container.clientHeight/t.container.clientWidth;if(i<e){n=t.container.clientHeight;s=n/i}else{s=t.container.clientWidth;n=s*i}t.width=t.dom.width=s*t.pixelRatio;t.height=t.dom.height=n*t.pixelRatio;t.dom.style.width=s+"px";t.dom.style.height=n+"px";return t.render()}}(this);if(this.fillParent){window.addEventListener("resize",t);this.dom.addEventListener("DOMNodeInserted",t)}i=function(t){return function(){t.startRenderTime=Bu.now();if(t.isRunning){if(t.clipMeter!=null){t.clipMeter.start()}t.render();t.trigger("update",{tickCount:t.tickCount});t.tickCount+=1;if(t.clipMeter!=null){t.clipMeter.tick()}}t.endRenderTime=Bu.now();t.nextRenderTime=Math.max(1e3/t.fps-t.endRenderTime+t.startRenderTime,1);return setTimeout(i,t.nextRenderTime)}}(this);i();if(this.container!=null){if(typeof this.container==="string"){this.container=document.querySelector(this.container)}setTimeout(function(t){return function(){return t.container.appendChild(t.dom)}}(this),100)}this.isRunning=true}t.prototype.pause=function(){return this.isRunning=false};t.prototype["continue"]=function(){return this.isRunning=true};t.prototype.toggle=function(){return this.isRunning=!this.isRunning};t.prototype.processArgs=function(t){return{offsetX:t.offsetX*this.pixelRatio,offsetY:t.offsetY*this.pixelRatio,button:t.button}};t.prototype.append=function(t){var e,i,n;if(t instanceof Array){for(e=0,i=t.length;e<i;e++){n=t[e];this.shapes.push(n)}}else{this.shapes.push(t)}return this};t.prototype.render=function(){this.clearCanvas();this.drawShapes(this.shapes);return this};t.prototype.clearCanvas=function(){this.context.clearRect(0,0,this.width,this.height);return this};t.prototype.drawShapes=function(t){var e,i,n;if(t!=null){for(e=0,i=t.length;e<i;e++){n=t[e];this.drawShape(n)}}return this};t.prototype.drawShape=function(t){if(!t.visible){return this}switch(t.type){case"Point":this.drawPoint(t);break;case"Line":this.drawLine(t);break;case"Circle":this.drawCircle(t);break;case"Triangle":this.drawTriangle(t);break;case"Rectangle":this.drawRectangle(t);break;case"Fan":this.drawFan(t);break;case"Bow":this.drawBow(t);break;case"Polygon":this.drawPolygon(t);break;case"Polyline":this.drawPolyline(t);break;case"PointText":this.drawPointText(t);break;case"Image":this.drawImage(t);break;case"Bounds":this.drawBounds(t);break;default:console.log("drawShapes(): unknown shape: ",t)}if(t.children!=null){this.drawShapes(t.children)}if(this.isShowKeyPoints){this.drawShapes(t.keyPoints)}return this};t.prototype.drawPoint=function(t){this.context.globalAlpha=t.opacity;if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fillRect(t.x-Bu.POINT_RENDER_SIZE/2,t.y-Bu.POINT_RENDER_SIZE/2,Bu.POINT_RENDER_SIZE,Bu.POINT_RENDER_SIZE)}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.strokeRect(t.x-Bu.POINT_RENDER_SIZE/2,t.y-Bu.POINT_RENDER_SIZE/2,Bu.POINT_RENDER_SIZE,Bu.POINT_RENDER_SIZE)}return this};t.prototype.drawLine=function(t){this.context.globalAlpha=t.opacity;if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.beginPath();if(t.dashStyle){this.context.dashedLine(t.points[0].x,t.points[0].y,t.points[1].x,t.points[1].y,t.dashStyle,t.dashDelta)}else{this.context.lineTo(t.points[0].x,t.points[0].y);this.context.lineTo(t.points[1].x,t.points[1].y);this.context.closePath()}this.context.stroke()}return this};t.prototype.drawCircle=function(t){this.context.globalAlpha=t.opacity;this.context.beginPath();this.context.arc(t.cx,t.cy,t.radius,0,Math.PI*2);this.context.closePath();if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fill()}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.stroke()}return this};t.prototype.drawTriangle=function(t){var e;this.context.globalAlpha=t.opacity;this.context.beginPath();this.context.lineTo(t.points[0].x,t.points[0].y);this.context.lineTo(t.points[1].x,t.points[1].y);this.context.lineTo(t.points[2].x,t.points[2].y);this.context.closePath();if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fill()}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;if(t.dashStyle){this.context.beginPath();e=t.points;this.context.dashedLine(e[0].x,e[0].y,e[1].x,e[1].y,t.dashStyle,t.dashDelta);this.context.dashedLine(e[1].x,e[1].y,e[2].x,e[2].y,t.dashStyle,t.dashDelta);this.context.dashedLine(e[2].x,e[2].y,e[0].x,e[0].y,t.dashStyle,t.dashDelta)}this.context.stroke()}return this};t.prototype.drawRectangle=function(t){var e,i,n,s;this.context.globalAlpha=t.opacity;if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fillRect(t.position.x,t.position.y,t.size.width,t.size.height)}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;if(!t.dashStyle){this.context.strokeRect(t.position.x,t.position.y,t.size.width,t.size.height)}else{this.context.beginPath();e=t.position.x;i=t.pointRB.x;s=t.position.y;n=t.pointRB.y;this.context.dashedLine(e,s,i,s,t.dashStyle,t.dashDelta);this.context.dashedLine(i,s,i,n,t.dashStyle,t.dashDelta);this.context.dashedLine(i,n,e,n,t.dashStyle,t.dashDelta);this.context.dashedLine(e,n,e,s,t.dashStyle,t.dashDelta);this.context.stroke()}}return this};t.prototype.drawFan=function(t){this.context.globalAlpha=t.opacity;this.context.beginPath();this.context.arc(t.cx,t.cy,t.radius,t.aFrom,t.aTo);this.context.lineTo(t.cx,t.cy);this.context.closePath();if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fill()}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.stroke()}return this};t.prototype.drawBow=function(t){this.context.globalAlpha=t.opacity;this.context.beginPath();this.context.arc(t.cx,t.cy,t.radius,t.aFrom,t.aTo);this.context.closePath();if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fill()}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.stroke()}return this};t.prototype.drawPolygon=function(t){var e,i,n,s,r,o,h,l,a;this.context.globalAlpha=t.opacity;this.context.beginPath();l=t.vertices;for(i=0,s=l.length;i<s;i++){o=l[i];this.context.lineTo(o.x,o.y)}this.context.closePath();if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fill()}if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;n=t.vertices.length;if(t.dashStyle&&n>0){this.context.beginPath();h=t.vertices;for(e=r=0,a=n-1;0<=a?r<a:r>a;e=0<=a?++r:--r){this.context.dashedLine(h[e].x,h[e].y,h[e+1].x,h[e+1].y,t.dashStyle,t.dashDelta)}this.context.dashedLine(h[n-1].x,h[n-1].y,h[0].x,h[0].y,t.dashStyle,t.dashDelta);this.context.stroke()}this.context.stroke()}return this};t.prototype.drawPolyline=function(t){var e,i,n,s,r,o,h,l;if(t.strokeStyle!=null){this.context.globalAlpha=t.opacity;this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.beginPath();if(!t.dashStyle){h=t.vertices;for(i=0,n=h.length;i<n;i++){r=h[i];this.context.lineTo(r.x,r.y)}}else{o=t.vertices;for(e=s=0,l=o.length-1;0<=l?s<l:s>l;e=0<=l?++s:--s){this.context.dashedLine(o[e].x,o[e].y,o[e+1].x,o[e+1].y,t.dashStyle,t.dashDelta)}}this.context.stroke()}return this};t.prototype.drawPointText=function(t){this.context.globalAlpha=t.opacity;this.context.textAlign=t.textAlign;this.context.textBaseline=t.textBaseline;this.context.font=t.font;if(t.strokeStyle!=null){this.context.strokeStyle=t.strokeStyle;this.context.lineWidth=t.lineWidth;this.context.strokeText(t.text,t.x,t.y)}if(t.fillStyle!=null){this.context.fillStyle=t.fillStyle;this.context.fillText(t.text,t.x,t.y)}return this};t.prototype.drawImage=function(t){var e,i,n,s;if(t.loaded){this.context.save();this.context.globalAlpha=t.opacity;s=t.size.width*t.scale.x;n=t.size.height*t.scale.y;e=-s*t.pivot.x;i=-n*t.pivot.y;this.context.translate(t.position.x,t.position.y);this.context.rotate(t.rotation);this.context.drawImage(t.image,e,i,s,n);this.context.restore()}return this};t.prototype.drawBounds=function(t){this.context.strokeStyle=t.strokeStyle;this.context.beginPath();this.context.dashedLine(t.x1,t.y1,t.x2,t.y1,t.dashStyle,t.dashDelta);this.context.dashedLine(t.x2,t.y1,t.x2,t.y2,t.dashStyle,t.dashDelta);this.context.dashedLine(t.x2,t.y2,t.x1,t.y2,t.dashStyle,t.dashDelta);this.context.dashedLine(t.x1,t.y2,t.x1,t.y1,t.dashStyle,t.dashDelta);this.context.stroke();return this};return t}();(function(t){return function(){var t;t=window.CanvasRenderingContext2D&&CanvasRenderingContext2D.prototype;return t.dashedLine=function(t,e,i,n,s,r){
var o,h,l,a,u,c,p,f,y,d,x;if(s==null){s=Bu.DEFAULT_DASH_STYLE}if(r==null){r=0}this.save();a=i-t;u=n-e;f=Bu.bevel(a,u);x=Math.atan2(u,a);this.translate(t,e);this.rotate(x);o=s.length;h=0;l=true;d=0;for(p=0,y=s.length;p<y;p++){c=s[p];d+=c}r%=d;t=r;this.moveTo(0,0);while(f>t){h+=1;t+=s[h%o];if(t>f){t=f}if(l){this.lineTo(t,0)}else{this.moveTo(t,0)}l=!l}this.restore();return this}}})(this)();Bu.RandomShapeGenerator=function(){var t;t=30;function e(t){this.renderer=t}e.prototype.randomX=function(){return Bu.rand(t,this.renderer.width-t*2)};e.prototype.randomY=function(){return Bu.rand(t,this.renderer.height-t*2)};e.prototype.randomRadius=function(){return Bu.rand(5,Math.min(this.renderer.width,this.renderer.height)/2)};e.prototype.generateCircle=function(){var t;t=new Bu.Circle(this.randomX(),this.randomY(),this.randomRadius());t.center.label="O";return t};e.prototype.generateBow=function(){var t,e,i;t=Bu.rand(Math.PI*2);e=t+Bu.rand(Math.PI/2,Math.PI*2);i=new Bu.Bow(this.randomX(),this.randomY(),this.randomRadius(),t,e);i.string.points[0].label="A";i.string.points[1].label="B";return i};e.prototype.generateTriangle=function(){var t,e,i,n;i=[];for(t=e=0;e<=2;t=++e){i[t]=new Bu.Point(this.randomX(),this.randomY())}n=new Bu.Triangle(i[0],i[1],i[2]);n.points[0].label="A";n.points[1].label="B";n.points[2].label="C";return n};e.prototype.generateRectangle=function(){return new Bu.Rectangle(Bu.rand(this.renderer.width),Bu.rand(this.renderer.height),Bu.rand(this.renderer.width/2),Bu.rand(this.renderer.height/2))};e.prototype.generateFan=function(){var t,e,i;t=Bu.rand(Math.PI*2);e=t+Bu.rand(Math.PI/2,Math.PI*2);i=new Bu.Fan(this.randomX(),this.randomY(),this.randomRadius(),t,e);i.string.points[0].label="A";i.string.points[1].label="B";return i};e.prototype.generatePolygon=function(){var t,e,i,n;n=[];for(t=e=0;e<=3;t=++e){i=new Bu.Point(this.randomX(),this.randomY());i.label="P"+t;n.push(i)}return new Bu.Polygon(n)};e.prototype.generateLine=function(){var t;t=new Bu.Line(this.randomX(),this.randomY(),this.randomX(),this.randomY());t.points[0].label="A";t.points[1].label="B";return t};e.prototype.generatePolyline=function(){var t,e,i,n;n=new Bu.Polyline;for(t=e=0;e<=3;t=++e){i=new Bu.Point(this.randomX(),this.randomY());i.label="P"+t;n.addPoint(i)}return n};return e}();