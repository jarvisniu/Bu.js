<!DOCTYPE html>
<html>
<head>
	<title>Morph</title>
	<meta charset="utf-8">
	<style type="text/css">

	body {
		background-color: #BBB;
	}

	#canvas {
		border: solid 1px gray;
		background-color: #FFF;
		width: 512px;
		height: 512px;
	}

	</style>
	<script src="polyline.js"></script>
	<script src="polylineMorpher.js"></script>
	<script src="render.js"></script>
	<script type="text/javascript">

	var CANVAS_WIDTH = 512;
	var CANVAS_HEIGHT = 512;

	var canvas, context;
	var polylineA, polylineB;
	var polylineMorpher;

	var pos = 0;

	function init() {

		canvas = document.getElementById("canvas");
		canvas.addEventListener("mouseup", onMouseUp);
		context = canvas.getContext("2d");
		context.strokeWidth = 1;

		var btnMorph = document.getElementById("btnMorph");
		btnMorph.addEventListener("click", onBtnMorphClick);

		polylineA = new Polyline();
		polylineA.addPoint(100, 300);
		// polylineA.addPoint(250, 100);
		// polylineA.addPoint(400, 300);
		// polylineA.addPoint(400, 100);

		polylineB = new Polyline();
		polylineB.addPoint(100, 400);
		// polylineB.addPoint(400, 400);

		polylineMorpher = new PolylineMorpher(polylineA, polylineB);

		render();

	}
	document.addEventListener("DOMContentLoaded", init);

	function onMouseUp(e) {

		if (e.button == 0) {
			polylineA.addPoint(e.offsetX, e.offsetY);
		} else {
			polylineB.addPoint(e.offsetX, e.offsetY);
		}
		polylineMorpher = new PolylineMorpher(polylineA, polylineB);

	}

	function render() {

		context.clearRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);

		renderHarmonizedPolylines();
		renderPolylines();

		setTimeout(render, 16);
	}

	function renderPolylines() {

		context.fillStyle = "black";
		renderPolyline(polylineA);
		renderPolyline(polylineB);
	}

	function renderHarmonizedPolylines() {


		context.beginPath();
		var points = polylineMorpher.getHarmonizedPointsC();
		for (var i in points) {
			context.lineTo(points[i].x, points[i].y);
		}
		context.stroke();

		context.fillStyle = "red";
		renderPoints(polylineMorpher.getHarmonizedPointsA());
		renderPoints(polylineMorpher.getHarmonizedPointsB());
		renderPoints(polylineMorpher.getHarmonizedPointsC());
	}

	function renderPolyline(polyline) {

		// line segments
		context.beginPath();
		var points = polyline.getPoints();
		for (var i in points) {
			context.lineTo(points[i].x, points[i].y);
		}
		context.stroke();

		// points
		for (i in points) {
			context.fillRect(points[i].x - 2, points[i].y - 2, 4, 4);
		}

	}

	function renderPoints(points) {

		for (i in points) {
			context.fillRect(points[i].x - 2, points[i].y - 2, 4, 4);
		}

	}

	function onBtnMorphClick(e) {

		pos = 0;

		animateMorph();

	}

	function animateMorph() {

		pos += 0.01;

		polylineMorpher.setPos(pos);

		if (pos < 1) setTimeout(animateMorph, 16);

	}

	</script>
</head>
<body>
	<canvas id="canvas" width="512" height="512"></canvas>
	<div>
		<button id="btnMorph">Morph</button>
	</div>
</body>
</html>